apiVersion: batch/v1
kind: CronJob
metadata:
  name: k3s-auto-upgrade
  namespace: system-upgrade
spec:
  schedule: "30 4 * * 0"  #At 04:30 on Sunday.
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: system-upgrade
          restartPolicy: OnFailure
          containers:
            - name: upgrade-checker
              image: ghcr.io/swebarre/systemd-containers:toolbox@sha256:db7d0e8b7255f5d937e3e9350eb1effe0b8b7f43fb8d24def9bb39028e79f00a
              command:
                - /bin/bash
                - -c
                - |
                  bash /scripts/auto-upgrade-plan.sh
              env:
                - name: UPGRADE_CHANNEL
                  value: stable
              volumeMounts:
                - name: script
                  mountPath: /scripts
          volumes:
            - name: script
              configMap:
                name: k3s-auto-upgrade-script
                defaultMode: 0755


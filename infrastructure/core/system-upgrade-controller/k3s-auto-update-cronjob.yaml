apiVersion: batch/v1
kind: CronJob
metadata:
  name: k3s-auto-upgrade
  namespace: system-upgrade
spec:
  schedule: "30 4 * * 0"  #At 04:30 on Sunday.
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: system-upgrade
          restartPolicy: OnFailure
          containers:
            - name: upgrade-checker
              image: ghcr.io/swebarre/systemd-containers:toolbox@sha256:c6861178f62d2177e1034f3085df151d38f15a8822c6cc59ce2cb2d5924d2517
              command:
                - /bin/bash
                - -c
                - |
                  bash /scripts/auto-upgrade-plan.sh
              env:
                - name: UPGRADE_CHANNEL
                  value: stable
              volumeMounts:
                - name: script
                  mountPath: /scripts
          volumes:
            - name: script
              configMap:
                name: k3s-auto-upgrade-script
                defaultMode: 0755

